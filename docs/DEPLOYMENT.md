# Deployment (Cloudflare Pages)

Last Updated: 2026-01-08

## Purpose
This is the single source of truth for deploying the Your Dedicated Marketer site to Cloudflare Pages.

## Cloudflare Pages build settings
Use the following values when creating the Pages project:

| Setting | Value | Notes |
| --- | --- | --- |
| Framework preset | Next.js (or None if unavailable) | Cloudflare should detect Next.js automatically. |
| Build command | `npm run pages:build` | Runs `@cloudflare/next-on-pages` (see `package.json`). |
| Build output directory | `.vercel/output/static` | Output generated by Next.js + adapter. |
| Root directory | `/` | Repo root. |
| Node.js version | `20` (>=20 <23) | Matches `package.json` engines. |
| NPM version | `10+` | Matches `package.json` engines. |

### Local preview
```bash
npm run pages:preview
```

## Environment variables
All secrets must be configured in Cloudflare Pages → Settings → Environment variables.

### Public (client-exposed)
| Variable | Required | Description |
| --- | --- | --- |
| `NEXT_PUBLIC_SITE_URL` | ✅ | Canonical base URL used in metadata. |
| `NEXT_PUBLIC_SITE_NAME` | ✅ | Brand name used in titles/metadata. |
| `NEXT_PUBLIC_ANALYTICS_ID` | ⚪ | Analytics provider ID (if configured). |
| `NEXT_PUBLIC_SENTRY_DSN` | ⚪ | Sentry public DSN (optional). |

### Server-only (secrets)
| Variable | Required | Description |
| --- | --- | --- |
| `RESEND_API_KEY` | ✅ | Required for the current email-based contact flow. Will be removed after T-053. |
| `CONTACT_EMAIL` | ✅ | Destination for contact form submissions. Will be removed after T-053. |
| `UPSTASH_REDIS_REST_URL` | ⚪ | Distributed rate limiting (recommended for production). |
| `UPSTASH_REDIS_REST_TOKEN` | ⚪ | Distributed rate limiting (recommended for production). |
| `SENTRY_AUTH_TOKEN` | ⚪ | Required if uploading source maps/releases. |
| `SENTRY_ORG` | ⚪ | Required if uploading source maps/releases. |
| `SENTRY_PROJECT` | ⚪ | Required if uploading source maps/releases. |
| `SENTRY_ENVIRONMENT` | ⚪ | Optional environment label for Sentry. |

### Lead capture pipeline (blocked by T-053/T-054/T-055)
These become required when the Supabase + HubSpot pipeline is enabled:

| Variable | Required | Description |
| --- | --- | --- |
| `SUPABASE_URL` | ✅ | Supabase project URL. |
| `SUPABASE_SERVICE_ROLE_KEY` | ✅ | Server-only service role key. |
| `HUBSPOT_PRIVATE_APP_TOKEN` | ✅ | HubSpot private app token. |

## Pre-deploy checklist
- [ ] Confirm `npm run build` completes locally.
- [ ] Ensure all required env vars are set in Cloudflare Pages.
- [ ] Validate rate limiting configuration for production traffic.
- [ ] Confirm Sentry DSN (if enabled) is correct.

## DNS / custom domain checklist
- [ ] Add custom domain in Cloudflare Pages (Custom Domains).
- [ ] Point DNS to the Pages domain (CNAME) or move DNS to Cloudflare for automatic setup.
- [ ] Verify SSL certificate is provisioned (may take up to 24 hours).
- [ ] Update `NEXT_PUBLIC_SITE_URL` to the production domain and redeploy.

## Rollback procedure
1. Open Cloudflare Pages → Deployments.
2. Locate the last known good deployment.
3. Use **Rollback** (or redeploy the previous commit).

## Post-deploy verification
Use the mobile-first checklist in `docs/ops/SMOKE_TEST.md` and confirm:
- [ ] Home, Services, Pricing, Contact pages load without errors.
- [ ] Contact form returns a success message.
- [ ] SEO tags render (title, description, OG image).

## Troubleshooting
- **Build fails**: confirm Node 20+ and rerun `npm run pages:build` locally.
- **404s**: ensure routes exist under `app/` and the build completed without errors.
- **Env var errors**: confirm all required secrets are defined (server-only vars without `NEXT_PUBLIC_`).
