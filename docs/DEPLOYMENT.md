# Deployment (Cloudflare Pages)

Last Updated: 2026-01-08

## Purpose
This is the single source of truth for deploying the Your Dedicated Marketer site to Cloudflare Pages.

## Cloudflare Pages build settings
Use the following values when creating the Pages project:

| Setting | Value | Notes |
| --- | --- | --- |
| Framework preset | Next.js (or None if unavailable) | Cloudflare should detect Next.js automatically. |
| Build command | `npm run pages:build` | Runs `@cloudflare/next-on-pages` (see `package.json`). |
| Build output directory | `.vercel/output/static` | Output generated by Next.js + adapter. |
| Root directory | `/` | Repo root. |
| Node.js version | `20` (>=20 <23) | Matches `package.json` engines. |
| NPM version | `10+` | Matches `package.json` engines. |

### Local preview
```bash
npm run pages:preview
```

## Environment variables
All secrets must be configured in Cloudflare Pages â†’ Settings â†’ Environment variables.

### Public (client-exposed)
| Variable | Required | Description |
| --- | --- | --- |
| `NEXT_PUBLIC_SITE_URL` | âšª | Base URL for metadata, sitemap, OG tags. Defaults to `http://localhost:3000` if not set. **Set in production** to your actual domain. |
| `NEXT_PUBLIC_SITE_NAME` | âšª | Brand name used in titles/metadata. Defaults to `"Your Dedicated Marketer"` if not set. |
| `NEXT_PUBLIC_ANALYTICS_ID` | âšª | Analytics provider ID (if configured). If not set, analytics tracking is disabled. |
| `NEXT_PUBLIC_SENTRY_DSN` | âšª | Sentry public DSN (optional). If not set, Sentry error tracking is disabled. **Note:** Not validated in `lib/env.ts` (used directly in Sentry config files). |
| `NEXT_PUBLIC_SENTRY_DEBUG` | âšª | Enable Sentry in development (defaults to disabled). **Note:** Not validated in `lib/env.ts`. |

### Server-only (secrets)
| Variable | Required | Description |
| --- | --- | --- |
| `RESEND_API_KEY` | âšª | Resend API key for email delivery. If not set, contact form logs to console and returns success. |
| `CONTACT_EMAIL` | âšª | Destination for contact form submissions. Defaults to `contact@yourdedicatedmarketer.com` if not set. |
| `UPSTASH_REDIS_REST_URL` | âšª | Distributed rate limiting (recommended for production). Falls back to in-memory if not set. Must be set together with `UPSTASH_REDIS_REST_TOKEN`. |
| `UPSTASH_REDIS_REST_TOKEN` | âšª | Distributed rate limiting (recommended for production). Must be set together with `UPSTASH_REDIS_REST_URL`. |
| `NODE_ENV` | âšª | Node environment (`development`, `production`, `test`). Defaults to `development` if not set. Usually set automatically by deployment platform. |
| `SENTRY_AUTH_TOKEN` | âšª | Sentry auth token (for source maps/releases only). **Note:** Not validated in `lib/env.ts` (used by build scripts only). |
| `SENTRY_ORG` | âšª | Sentry organization slug (for source maps/releases only). **Note:** Not validated in `lib/env.ts`. |
| `SENTRY_PROJECT` | âšª | Sentry project slug (for source maps/releases only). **Note:** Not validated in `lib/env.ts`. |
| `SENTRY_ENVIRONMENT` | âšª | Sentry environment label. **Note:** Not validated in `lib/env.ts` (used by Sentry config files). |

### Lead capture pipeline (future - T-080/T-081)
These are currently optional and will become required when the Supabase + HubSpot pipeline is implemented:

| Variable | Required | Description |
| --- | --- | --- |
| `SUPABASE_URL` | ðŸ”® Future | Supabase project URL. Currently optional. |
| `SUPABASE_SERVICE_ROLE_KEY` | ðŸ”® Future | Server-only service role key. Currently optional. |
| `HUBSPOT_PRIVATE_APP_TOKEN` | ðŸ”® Future | HubSpot private app token. Currently optional. |

## Pre-deploy checklist
- [ ] Confirm `npm run build` completes locally.
- [ ] Set `NEXT_PUBLIC_SITE_URL` to your production domain in Cloudflare Pages.
- [ ] Set `NEXT_PUBLIC_SITE_NAME` if different from default.
- [ ] Configure optional integrations (analytics, Sentry, rate limiting) as needed.
- [ ] Validate rate limiting configuration for production traffic (recommended: set Upstash Redis vars).
- [ ] Confirm Sentry DSN (if enabled) is correct.

## DNS / custom domain checklist
- [ ] Add custom domain in Cloudflare Pages (Custom Domains).
- [ ] Point DNS to the Pages domain (CNAME) or move DNS to Cloudflare for automatic setup.
- [ ] Verify SSL certificate is provisioned (may take up to 24 hours).
- [ ] Update `NEXT_PUBLIC_SITE_URL` to the production domain and redeploy.

## Rollback procedure
1. Open Cloudflare Pages â†’ Deployments.
2. Locate the last known good deployment.
3. Use **Rollback** (or redeploy the previous commit).

## Post-deploy verification
Use the mobile-first checklist in `docs/ops/SMOKE_TEST.md` and confirm:
- [ ] Home, Services, Pricing, Contact pages load without errors.
- [ ] Contact form returns a success message.
- [ ] SEO tags render (title, description, OG image).

## Troubleshooting
- **Build fails**: confirm Node 20+ and rerun `npm run pages:build` locally.
- **404s**: ensure routes exist under `app/` and the build completed without errors.
- **Env var errors**: confirm all required secrets are defined (server-only vars without `NEXT_PUBLIC_`).
