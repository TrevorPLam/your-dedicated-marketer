# Deployment (Cloudflare Pages)

Last Updated: 2026-01-08

## Purpose
This is the single source of truth for deploying the Your Dedicated Marketer site to Cloudflare Pages.

## Cloudflare Pages build settings
Use the following values when creating the Pages project:

| Setting | Value | Notes |
| --- | --- | --- |
| Framework preset | Next.js (or None if unavailable) | Cloudflare should detect Next.js automatically. |
| Build command | `npm run pages:build` | Runs `@cloudflare/next-on-pages` (see `package.json`). |
| Build output directory | `.vercel/output/static` | Output generated by Next.js + adapter. |
| Root directory | `/` | Repo root. |
| Node.js version | `20` (>=20 <23) | Matches `package.json` engines. |
| NPM version | `10+` | Matches `package.json` engines. |

### Local preview
```bash
npm run pages:preview
```

## Environment variables
All secrets must be configured in Cloudflare Pages â†’ Settings â†’ Environment variables.

### Public (client-exposed)
| Variable | Required | Description |
| --- | --- | --- |
| `NEXT_PUBLIC_SITE_URL` | âœ… | Canonical base URL used in metadata. |
| `NEXT_PUBLIC_SITE_NAME` | âœ… | Brand name used in titles/metadata. |
| `NEXT_PUBLIC_ANALYTICS_ID` | âšª | Analytics provider ID (if configured). |
| `NEXT_PUBLIC_SENTRY_DSN` | âšª | Sentry public DSN (optional). |

### Server-only (secrets)
| Variable | Required | Description |
| --- | --- | --- |
| `RESEND_API_KEY` | âšª | Optional: Resend API key for email delivery. If not set, contact form logs to console (development mode). |
| `CONTACT_EMAIL` | âœ… | Required: Destination for contact form submissions. Defaults to `contact@yourdedicatedmarketer.com` if not set. |
| `UPSTASH_REDIS_REST_URL` | âšª | Optional: Distributed rate limiting (recommended for production). Falls back to in-memory if not set. |
| `UPSTASH_REDIS_REST_TOKEN` | âšª | Optional: Distributed rate limiting (recommended for production). Must be set with `UPSTASH_REDIS_REST_URL`. |
| `SENTRY_AUTH_TOKEN` | âšª | Optional: Required only if uploading source maps/releases. |
| `SENTRY_ORG` | âšª | Optional: Required only if uploading source maps/releases. |
| `SENTRY_PROJECT` | âšª | Optional: Required only if uploading source maps/releases. |
| `SENTRY_ENVIRONMENT` | âšª | Optional: Environment label for Sentry. |

### Lead capture pipeline (future - T-080/T-081)
These are currently optional and will become required when the Supabase + HubSpot pipeline is implemented:

| Variable | Required | Description |
| --- | --- | --- |
| `SUPABASE_URL` | ðŸ”® Future | Supabase project URL. Currently optional. |
| `SUPABASE_SERVICE_ROLE_KEY` | ðŸ”® Future | Server-only service role key. Currently optional. |
| `HUBSPOT_PRIVATE_APP_TOKEN` | ðŸ”® Future | HubSpot private app token. Currently optional. |

## Pre-deploy checklist
- [ ] Confirm `npm run build` completes locally.
- [ ] Ensure all required env vars are set in Cloudflare Pages.
- [ ] Validate rate limiting configuration for production traffic.
- [ ] Confirm Sentry DSN (if enabled) is correct.

## DNS / custom domain checklist
- [ ] Add custom domain in Cloudflare Pages (Custom Domains).
- [ ] Point DNS to the Pages domain (CNAME) or move DNS to Cloudflare for automatic setup.
- [ ] Verify SSL certificate is provisioned (may take up to 24 hours).
- [ ] Update `NEXT_PUBLIC_SITE_URL` to the production domain and redeploy.

## Rollback procedure
1. Open Cloudflare Pages â†’ Deployments.
2. Locate the last known good deployment.
3. Use **Rollback** (or redeploy the previous commit).

## Post-deploy verification
Use the mobile-first checklist in `docs/ops/SMOKE_TEST.md` and confirm:
- [ ] Home, Services, Pricing, Contact pages load without errors.
- [ ] Contact form returns a success message.
- [ ] SEO tags render (title, description, OG image).

## Troubleshooting
- **Build fails**: confirm Node 20+ and rerun `npm run pages:build` locally.
- **404s**: ensure routes exist under `app/` and the build completed without errors.
- **Env var errors**: confirm all required secrets are defined (server-only vars without `NEXT_PUBLIC_`).
