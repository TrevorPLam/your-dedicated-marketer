# Deployment (Cloudflare Pages)

Last Updated: 2026-01-08

## Purpose
This is the single source of truth for deploying the Your Dedicated Marketer site to Cloudflare Pages.

## Cloudflare Pages build settings
Use the following values when creating the Pages project:

| Setting | Value | Notes |
| --- | --- | --- |
| Framework preset | Next.js (or None if unavailable) | Cloudflare should detect Next.js automatically. |
| Build command | `npm run pages:build` | Runs `@cloudflare/next-on-pages` (see `package.json`). |
| Build output directory | `.vercel/output/static` | Output generated by Next.js + adapter. |
| Root directory | `/` | Repo root. |
| Node.js version | `20` (>=20 <23) | Matches `package.json` engines. |
| NPM version | `10+` | Matches `package.json` engines. |

### Local preview
```bash
npm run pages:preview
```

## Environment variables
All secrets must be configured in Cloudflare Pages → Settings → Environment variables.

### Public (client-exposed)
| Variable | Required | Description |
| --- | --- | --- |
| `NEXT_PUBLIC_SITE_URL` | ⚪ | Base URL for metadata, sitemap, OG tags. Defaults to `http://localhost:3000` if not set. **Set in production** to your actual domain. |
| `NEXT_PUBLIC_SITE_NAME` | ⚪ | Brand name used in titles/metadata. Defaults to `"Your Dedicated Marketer"` if not set. |
| `NEXT_PUBLIC_ANALYTICS_ID` | ⚪ | Analytics provider ID (if configured). If not set, analytics tracking is disabled. |
| `NEXT_PUBLIC_SENTRY_DSN` | ⚪ | Sentry public DSN (optional). If not set, Sentry error tracking is disabled. **Note:** Not validated in `lib/env.ts` (used directly in Sentry config files). |
| `NEXT_PUBLIC_SENTRY_DEBUG` | ⚪ | Enable Sentry in development (defaults to disabled). **Note:** Not validated in `lib/env.ts`. |

### Server-only (secrets)
| Variable | Required | Description |
| --- | --- | --- |
| `UPSTASH_REDIS_REST_URL` | ⚪ | Distributed rate limiting (recommended for production). Falls back to in-memory if not set. Must be set together with `UPSTASH_REDIS_REST_TOKEN`. |
| `UPSTASH_REDIS_REST_TOKEN` | ⚪ | Distributed rate limiting (recommended for production). Must be set together with `UPSTASH_REDIS_REST_URL`. |
| `NODE_ENV` | ⚪ | Node environment (`development`, `production`, `test`). Defaults to `development` if not set. Usually set automatically by deployment platform. |
| `SENTRY_AUTH_TOKEN` | ⚪ | Sentry auth token (for source maps/releases only). **Note:** Not validated in `lib/env.ts` (used by build scripts only). |
| `SENTRY_ORG` | ⚪ | Sentry organization slug (for source maps/releases only). **Note:** Not validated in `lib/env.ts`. |
| `SENTRY_PROJECT` | ⚪ | Sentry project slug (for source maps/releases only). **Note:** Not validated in `lib/env.ts`. |
| `SENTRY_ENVIRONMENT` | ⚪ | Sentry environment label. **Note:** Not validated in `lib/env.ts` (used by Sentry config files). |

### Lead capture pipeline (v1 required)
These are required for the v1 contact pipeline (Supabase storage + HubSpot CRM sync):

| Variable | Required | Description |
| --- | --- | --- |
| `SUPABASE_URL` | ✅ | Supabase project URL (server-only). |
| `SUPABASE_SERVICE_ROLE_KEY` | ✅ | Supabase service role key (server-only). |
| `HUBSPOT_PRIVATE_APP_TOKEN` | ✅ | HubSpot private app token (server-only). |

### Contact pipeline behavior
- Contact submissions are always written to Supabase first (required).
- Rate-limited submissions are still stored, flagged with `is_suspicious` and `suspicion_reason = "rate_limit"`.
- HubSpot sync is best-effort: failures do **not** block a user-facing success response.
- HubSpot failures are recorded in Supabase with `hubspot_sync_status = "needs_sync"` and a timestamp.

## Pre-deploy checklist
- [ ] Confirm `npm run build` completes locally.
- [ ] Set `NEXT_PUBLIC_SITE_URL` to your production domain in Cloudflare Pages.
- [ ] Set `NEXT_PUBLIC_SITE_NAME` if different from default.
- [ ] Configure optional integrations (analytics, Sentry, rate limiting) as needed.
- [ ] Validate rate limiting configuration for production traffic (recommended: set Upstash Redis vars).
- [ ] Confirm Sentry DSN (if enabled) is correct.

## DNS / custom domain checklist
- [ ] Add custom domain in Cloudflare Pages (Custom Domains).
- [ ] Point DNS to the Pages domain (CNAME) or move DNS to Cloudflare for automatic setup.
- [ ] Verify SSL certificate is provisioned (may take up to 24 hours).
- [ ] Update `NEXT_PUBLIC_SITE_URL` to the production domain and redeploy.

## Rollback procedure
1. Open Cloudflare Pages → Deployments.
2. Locate the last known good deployment.
3. Use **Rollback** (or redeploy the previous commit).

## Post-deploy verification
Use the mobile-first checklist in `docs/ops/SMOKE_TEST.md` and confirm:
- [ ] Home, Services, Pricing, Contact pages load without errors.
- [ ] Contact form returns a success message.
- [ ] SEO tags render (title, description, OG image).

## Troubleshooting
- **Build fails**: confirm Node 20+ and rerun `npm run pages:build` locally.
- **404s**: ensure routes exist under `app/` and the build completed without errors.
- **Env var errors**: confirm all required secrets are defined (server-only vars without `NEXT_PUBLIC_`).
